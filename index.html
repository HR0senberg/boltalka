<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>P2P Chat - Decentralized Messaging</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    
    <style>
        /* Modern Design System Variables */
        :root {
            /* Colors */
            --color-background: #fafbfc;
            --color-surface: #ffffff;
            --color-text: #1a202c;
            --color-text-secondary: #718096;
            --color-gradient-start: #667eea;
            --color-gradient-end: #764ba2;
            --color-status-disconnected: #f56565;
            --color-status-connecting: #ed8936;
            --color-status-connected: #48bb78;
            --color-own-message-start: #e6f7ff;
            --color-own-message-end: #bae6fd;
            --color-partner-message: #f7fafc;
            --color-border: #e2e8f0;
            --color-border-light: #edf2f7;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-shadow-dark: rgba(0, 0, 0, 0.04);
            --color-hover-bg: #f7fafc;
            --color-button-secondary-bg: #f7fafc;
            --color-button-secondary-border: #e2e8f0;
            --color-button-danger-bg: #fee;
            --color-button-danger-text: #f56565;
            --color-button-danger-border: #fca5a5;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-2xl: 32px;
            --space-3xl: 48px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 12px;
            --radius-pill: 24px;
            
            /* Typography */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.5rem;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --line-height: 1.6;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
            --transition-slow: 300ms ease;
        }
        
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            font-size: 14px;
            line-height: var(--line-height);
            color: var(--color-text);
            background-color: var(--color-background);
            padding: 10px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Layout */
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-gradient-start) 0%, var(--color-gradient-end) 100%);
            color: white;
            padding: var(--space-lg) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }
        
        .header h1 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            letter-spacing: -0.02em;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: rgba(255, 255, 255, 0.15);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-pill);
            font-size: var(--font-size-sm);
            backdrop-filter: blur(10px);
            font-weight: var(--font-weight-medium);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-status-disconnected);
            transition: all var(--transition-slow);
        }
        
        .status-dot.connected {
            background: var(--color-status-connected);
        }
        
        .status-dot.connecting {
            background: var(--color-status-connecting);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.15);
            }
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Setup Panel */
        .setup-panel {
            padding: var(--space-xl);
            overflow-y: auto;
        }
        
        .setup-panel.hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: var(--space-xl);
            border-bottom: 1px solid var(--color-border);
        }
        
        .tab {
            padding: var(--space-md) var(--space-lg);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-slow);
            flex: 1;
            min-height: 44px;
            position: relative;
        }
        
        .tab:hover:not(.active) {
            background: var(--color-hover-bg);
            color: var(--color-text);
        }
        
        .tab.active {
            color: var(--color-gradient-start);
            border-bottom-color: var(--color-gradient-start);
            font-weight: var(--font-weight-semibold);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-xl);
        }
        
        label {
            display: block;
            margin-bottom: var(--space-md);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-family: monospace;
            resize: vertical;
            background: var(--color-surface);
            color: var(--color-text);
            line-height: var(--line-height);
            transition: all var(--transition-normal);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--color-gradient-start);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        textarea[readonly] {
            background: var(--color-background);
            cursor: default;
        }
        
        /* Buttons */
        .btn {
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            min-height: 44px;
            min-width: 44px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--color-gradient-start) 0%, var(--color-gradient-end) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-secondary {
            background: var(--color-button-secondary-bg);
            color: var(--color-text);
            border: 1px solid var(--color-button-secondary-border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--color-border-light);
            border-color: var(--color-gradient-start);
        }
        
        .btn-danger {
            background: var(--color-button-danger-bg);
            color: var(--color-button-danger-text);
            border: 1px solid var(--color-button-danger-border);
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #fecaca;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }
        
        .btn-full {
            width: 100%;
        }
        
        /* Chat Area */
        .chat-area {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .chat-area.active {
            display: flex;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.own {
            align-self: flex-end;
            align-items: flex-end;
        }
        
        .message.partner {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        .message-content {
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            line-height: var(--line-height);
        }
        
        .message.own .message-content {
            background: linear-gradient(135deg, var(--color-own-message-start) 0%, var(--color-own-message-end) 100%);
            color: var(--color-text);
            border-bottom-right-radius: var(--space-xs);
        }
        
        .message.partner .message-content {
            background: var(--color-partner-message);
            color: var(--color-text);
            border-bottom-left-radius: var(--space-xs);
        }
        
        .message-time {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-xs);
            font-weight: var(--font-weight-normal);
        }
        
        /* Input Area */
        .input-area {
            padding: var(--space-lg);
            border-top: 1px solid var(--color-border);
            background: var(--color-background);
            flex-shrink: 0;
        }
        
        .input-group {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .message-input {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
            font-family: inherit;
            background: var(--color-surface);
            color: var(--color-text);
            transition: all var(--transition-normal);
        }
        
        .message-input::placeholder {
            color: var(--color-text-secondary);
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--color-gradient-start);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        /* Footer */
        .footer {
            padding: var(--space-md);
            text-align: center;
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            border-top: 1px solid var(--color-border);
            background: var(--color-background);
            flex-shrink: 0;
            font-weight: var(--font-weight-normal);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--color-surface);
            padding: var(--space-2xl);
            border-radius: var(--radius-lg);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            text-align: center;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: var(--space-lg);
            right: var(--space-lg);
            background: var(--color-border);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            color: var(--color-text);
        }
        
        .modal-close:hover {
            background: var(--color-text-secondary);
            color: white;
            transform: rotate(90deg);
        }
        
        #qrcode {
            margin: var(--space-xl) auto;
            display: inline-block;
            padding: var(--space-lg);
            background: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }
        
        /* QR Scanner */
        #scanner-video {
            max-width: 100%;
            border-radius: var(--radius-sm);
            margin: var(--space-lg) 0;
            box-shadow: var(--shadow-md);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--color-surface);
            padding: var(--space-lg) var(--space-xl);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
            max-width: 320px;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification.success {
            border-left: 4px solid var(--color-status-connected);
            background: linear-gradient(to right, rgba(72, 187, 120, 0.1), var(--color-surface));
        }
        
        .notification.error {
            border-left: 4px solid var(--color-status-disconnected);
            background: linear-gradient(to right, rgba(245, 101, 101, 0.1), var(--color-surface));
        }
        
        /* Responsive Design */
        @media (min-width: 600px) {
            body {
                font-size: 15px;
                padding: var(--space-lg);
            }
            
            .container {
                height: calc(100vh - 32px);
            }
            
            textarea {
                min-height: 140px;
            }
            
            .setup-panel {
                padding: var(--space-2xl);
            }
            
            .header {
                padding: var(--space-lg) var(--space-2xl);
            }
        }
        
        @media (min-width: 1024px) {
            body {
                font-size: 16px;
                padding: var(--space-2xl);
            }
            
            .container {
                max-width: 1200px;
                height: calc(100vh - 64px);
            }
            
            .message {
                max-width: 70%;
            }
            
            .modal-content {
                max-width: 600px;
            }
            
            .setup-panel {
                padding: var(--space-3xl);
            }
            
            .header {
                padding: var(--space-xl) var(--space-3xl);
            }
            
            .input-area {
                padding: var(--space-xl);
            }
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--color-background);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-sm {
            margin-bottom: var(--space-sm);
        }
        
        .mb-md {
            margin-bottom: var(--space-md);
        }
        
        .mb-lg {
            margin-bottom: var(--space-lg);
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>P2P Chat</h1>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Setup Panel -->
            <div class="setup-panel" id="setupPanel">
                <div class="tabs">
                    <button class="tab active" data-tab="create">–°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                    <button class="tab" data-tab="join">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                </div>
                
                <!-- Create Connection Tab -->
                <div class="tab-content active" id="createTab">
                    <div class="form-group">
                        <button class="btn btn-primary btn-full" id="createOfferBtn">
                            üîó –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                        </button>
                    </div>
                    
                    <div class="form-group" id="offerGroup" style="display: none;">
                        <label>SDP Offer (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é):</label>
                        <textarea id="offerTextarea" readonly placeholder="SDP offer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="copyOfferBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-secondary" id="showOfferQRBtn">üì± –ü–æ–∫–∞–∑–∞—Ç—å QR</button>
                        </div>
                    </div>
                    
                    <div class="form-group" id="answerGroup" style="display: none;">
                        <label>–í–≤–µ–¥–∏—Ç–µ SDP Answer:</label>
                        <textarea id="answerInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ SDP answer –æ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è..."></textarea>
                        <button class="btn btn-primary btn-full" id="confirmAnswerBtn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </div>
                </div>
                
                <!-- Join Connection Tab -->
                <div class="tab-content" id="joinTab">
                    <div class="form-group">
                        <label>–í–≤–µ–¥–∏—Ç–µ SDP Offer –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞:</label>
                        <textarea id="offerInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ SDP offer –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR-—Å–∫–∞–Ω–µ—Ä..."></textarea>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="scanOfferQRBtn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
                            <button class="btn btn-primary" id="confirmOfferBtn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="form-group" id="generatedAnswerGroup" style="display: none;">
                        <label>SDP Answer (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É):</label>
                        <textarea id="answerTextarea" readonly placeholder="SDP answer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="copyAnswerBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-secondary" id="showAnswerQRBtn">üì± –ü–æ–∫–∞–∑–∞—Ç—å QR</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="messages" id="messages"></div>
                
                <div class="input-area">
                    <div class="input-group">
                        <input type="text" class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                        <button class="btn btn-primary" id="sendBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="clearChatBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                        <button class="btn btn-danger" id="disconnectBtn">üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            üîí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤, –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é P2P
        </div>
    </div>
    
    <!-- QR Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <button class="modal-close" id="closeQRModal">√ó</button>
            <h2 class="mb-md">QR –ö–æ–¥</h2>
            <div id="qrcode"></div>
            <p class="text-center" style="margin-top: var(--space-md); color: var(--color-text-secondary);">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>
        </div>
    </div>
    
    <!-- Scanner Modal -->
    <div class="modal" id="scannerModal">
        <div class="modal-content">
            <button class="modal-close" id="closeScannerModal">√ó</button>
            <h2 class="mb-md">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</h2>
            <video id="scanner-video" autoplay playsinline></video>
            <canvas id="scanner-canvas" style="display: none;"></canvas>
            <p class="text-center" style="color: var(--color-text-secondary);">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</p>
        </div>
    </div>
    
    <script>
        // Application State
        const state = {
            role: null, // 'initiator' or 'receiver'
            connectionState: 'disconnected',
            peerConnection: null,
            dataChannel: null,
            localSDP: null,
            remoteSDP: null,
            messages: [],
            scannerStream: null,
            scannerAnimationId: null,
            // WebRTC state tracking flags
            localDescriptionSet: false,
            remoteDescriptionSet: false,
            offerCreated: false,
            answerCreated: false
        };
        
        // Reset connection state flags
        function resetConnectionState() {
            state.localDescriptionSet = false;
            state.remoteDescriptionSet = false;
            state.offerCreated = false;
            state.answerCreated = false;
            console.log('Connection state flags reset');
        }
        
        // Log WebRTC state for debugging
        function logState(message) {
            const pc = state.peerConnection;
            if (pc) {
                console.log(`${message}:`, {
                    signalingState: pc.signalingState,
                    connectionState: pc.connectionState,
                    iceConnectionState: pc.iceConnectionState,
                    iceGatheringState: pc.iceGatheringState,
                    flags: {
                        localDescriptionSet: state.localDescriptionSet,
                        remoteDescriptionSet: state.remoteDescriptionSet,
                        offerCreated: state.offerCreated,
                        answerCreated: state.answerCreated
                    },
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // DOM Elements
        const elements = {
            // Status
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            
            // Panels
            setupPanel: document.getElementById('setupPanel'),
            chatArea: document.getElementById('chatArea'),
            
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            createTab: document.getElementById('createTab'),
            joinTab: document.getElementById('joinTab'),
            
            // Create Connection
            createOfferBtn: document.getElementById('createOfferBtn'),
            offerGroup: document.getElementById('offerGroup'),
            offerTextarea: document.getElementById('offerTextarea'),
            copyOfferBtn: document.getElementById('copyOfferBtn'),
            showOfferQRBtn: document.getElementById('showOfferQRBtn'),
            answerGroup: document.getElementById('answerGroup'),
            answerInput: document.getElementById('answerInput'),
            confirmAnswerBtn: document.getElementById('confirmAnswerBtn'),
            
            // Join Connection
            offerInput: document.getElementById('offerInput'),
            scanOfferQRBtn: document.getElementById('scanOfferQRBtn'),
            confirmOfferBtn: document.getElementById('confirmOfferBtn'),
            generatedAnswerGroup: document.getElementById('generatedAnswerGroup'),
            answerTextarea: document.getElementById('answerTextarea'),
            copyAnswerBtn: document.getElementById('copyAnswerBtn'),
            showAnswerQRBtn: document.getElementById('showAnswerQRBtn'),
            
            // Chat
            messages: document.getElementById('messages'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            
            // Modals
            qrModal: document.getElementById('qrModal'),
            closeQRModal: document.getElementById('closeQRModal'),
            qrcodeContainer: document.getElementById('qrcode'),
            scannerModal: document.getElementById('scannerModal'),
            closeScannerModal: document.getElementById('closeScannerModal'),
            scannerVideo: document.getElementById('scanner-video'),
            scannerCanvas: document.getElementById('scanner-canvas')
        };
        
        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        
        // Initialize Application
        function init() {
            setupEventListeners();
            updateConnectionStatus('disconnected');
            updateUIState();
            console.log('P2P Chat initialized');
        }
        
        // Setup Event Listeners
        function setupEventListeners() {
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Create connection
            elements.createOfferBtn.addEventListener('click', createOffer);
            elements.copyOfferBtn.addEventListener('click', () => copyToClipboard(elements.offerTextarea.value, 'Offer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
            elements.showOfferQRBtn.addEventListener('click', () => showQRCode(elements.offerTextarea.value));
            elements.confirmAnswerBtn.addEventListener('click', confirmAnswer);
            
            // Join connection
            elements.scanOfferQRBtn.addEventListener('click', startQRScanner);
            elements.confirmOfferBtn.addEventListener('click', confirmOffer);
            elements.copyAnswerBtn.addEventListener('click', () => copyToClipboard(elements.answerTextarea.value, 'Answer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
            elements.showAnswerQRBtn.addEventListener('click', () => showQRCode(elements.answerTextarea.value));
            
            // Chat
            elements.sendBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            elements.clearChatBtn.addEventListener('click', clearChat);
            elements.disconnectBtn.addEventListener('click', disconnect);
            
            // Modals
            elements.closeQRModal.addEventListener('click', closeQRModal);
            elements.closeScannerModal.addEventListener('click', stopQRScanner);
            elements.qrModal.addEventListener('click', (e) => {
                if (e.target === elements.qrModal) closeQRModal();
            });
            elements.scannerModal.addEventListener('click', (e) => {
                if (e.target === elements.scannerModal) stopQRScanner();
            });
        }
        
        // Tab Switching
        function switchTab(tabName) {
            elements.tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            if (tabName === 'create') {
                elements.createTab.classList.add('active');
                elements.joinTab.classList.remove('active');
            } else {
                elements.createTab.classList.remove('active');
                elements.joinTab.classList.add('active');
            }
        }
        
        // WebRTC Functions
        async function createOffer() {
            try {
                // Validate state
                if (state.peerConnection && state.peerConnection.signalingState !== 'stable') {
                    showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å offer. –°–æ—Å—Ç–æ—è–Ω–∏–µ: ' + state.peerConnection.signalingState, 'error');
                    return;
                }
                
                if (state.offerCreated) {
                    showNotification('Offer —É–∂–µ —Å–æ–∑–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.', 'error');
                    return;
                }
                
                state.role = 'initiator';
                resetConnectionState();
                updateConnectionStatus('gathering');
                
                // Create peer connection
                state.peerConnection = new RTCPeerConnection(rtcConfig);
                setupPeerConnectionListeners();
                
                logState('Before creating peer connection');
                
                // Create data channel
                state.dataChannel = state.peerConnection.createDataChannel('chat');
                setupDataChannelListeners(state.dataChannel);
                
                // Create offer
                logState('Before createOffer');
                const offer = await state.peerConnection.createOffer();
                
                logState('Before setLocalDescription');
                await state.peerConnection.setLocalDescription(offer);
                state.localDescriptionSet = true;
                state.offerCreated = true;
                
                logState('After setLocalDescription');
                
                // Wait for ICE gathering to complete
                await waitForICEGathering();
                
                // Display offer
                state.localSDP = state.peerConnection.localDescription.sdp;
                elements.offerTextarea.value = JSON.stringify(state.peerConnection.localDescription);
                elements.offerGroup.style.display = 'block';
                elements.answerGroup.style.display = 'block';
                
                updateUIState();
                showNotification('Offer —Å–æ–∑–¥–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é.', 'success');
            } catch (error) {
                console.error('Error creating offer:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        async function confirmOffer() {
            try {
                const offerText = elements.offerInput.value.trim();
                if (!offerText) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ SDP offer', 'error');
                    return;
                }
                
                // Validate state
                if (state.peerConnection && state.peerConnection.signalingState !== 'stable') {
                    showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å offer. –û–∂–∏–¥–∞–µ—Ç—Å—è: stable. –¢–µ–∫—É—â–µ–µ: ' + state.peerConnection.signalingState, 'error');
                    return;
                }
                
                if (state.remoteDescriptionSet) {
                    showNotification('Remote description —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.', 'error');
                    return;
                }
                
                state.role = 'receiver';
                resetConnectionState();
                updateConnectionStatus('gathering');
                
                // Parse offer
                const offer = JSON.parse(offerText);
                
                // Create peer connection
                state.peerConnection = new RTCPeerConnection(rtcConfig);
                setupPeerConnectionListeners();
                
                logState('Before setting up peer connection');
                
                // Setup data channel listener
                state.peerConnection.ondatachannel = (event) => {
                    state.dataChannel = event.channel;
                    setupDataChannelListeners(state.dataChannel);
                };
                
                // Set remote description (offer)
                logState('Before setRemoteDescription (offer)');
                
                if (state.peerConnection.signalingState !== 'stable') {
                    showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å offer. –û–∂–∏–¥–∞–µ—Ç—Å—è: stable. –¢–µ–∫—É—â–µ–µ: ' + state.peerConnection.signalingState, 'error');
                    return;
                }
                
                await state.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                state.remoteDescriptionSet = true;
                
                logState('After setRemoteDescription (offer)');
                
                // Create answer
                await createAnswerFromOffer();
                
            } catch (error) {
                console.error('Error confirming offer:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        async function createAnswerFromOffer() {
            try {
                // Validate state
                if (state.peerConnection.signalingState !== 'have-remote-offer') {
                    showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å answer. –û–∂–∏–¥–∞–µ—Ç—Å—è: have-remote-offer. –¢–µ–∫—É—â–µ–µ: ' + state.peerConnection.signalingState, 'error');
                    return;
                }
                
                if (state.answerCreated) {
                    showNotification('Answer —É–∂–µ —Å–æ–∑–¥–∞–Ω.', 'error');
                    return;
                }
                
                logState('Before createAnswer');
                const answer = await state.peerConnection.createAnswer();
                
                logState('Before setLocalDescription (answer)');
                await state.peerConnection.setLocalDescription(answer);
                state.localDescriptionSet = true;
                state.answerCreated = true;
                
                logState('After setLocalDescription (answer)');
                
                // Wait for ICE gathering to complete
                await waitForICEGathering();
                
                // Display answer
                state.localSDP = state.peerConnection.localDescription.sdp;
                elements.answerTextarea.value = JSON.stringify(state.peerConnection.localDescription);
                elements.generatedAnswerGroup.style.display = 'block';
                
                updateUIState();
                showNotification('Answer —Å–æ–∑–¥–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É.', 'success');
            } catch (error) {
                console.error('Error creating answer:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è answer: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        async function confirmAnswer() {
            try {
                const answerText = elements.answerInput.value.trim();
                if (!answerText) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ SDP answer', 'error');
                    return;
                }
                
                // Validate state - must be in 'have-local-offer' state
                if (!state.peerConnection) {
                    showNotification('Peer connection –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                    return;
                }
                
                logState('Before setting answer');
                
                if (state.peerConnection.signalingState !== 'have-local-offer') {
                    showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å answer. –û–∂–∏–¥–∞–µ—Ç—Å—è: have-local-offer. –¢–µ–∫—É—â–µ–µ: ' + state.peerConnection.signalingState, 'error');
                    return;
                }
                
                if (state.remoteDescriptionSet) {
                    showNotification('Remote description —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.', 'error');
                    return;
                }
                
                updateConnectionStatus('connecting');
                
                // Parse answer
                const answer = JSON.parse(answerText);
                
                // Validate answer type
                if (answer.type !== 'answer') {
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø SDP. –û–∂–∏–¥–∞–µ—Ç—Å—è: answer', 'error');
                    return;
                }
                
                // Set remote description
                logState('Before setRemoteDescription (answer)');
                await state.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                state.remoteDescriptionSet = true;
                
                logState('After setRemoteDescription (answer)');
                
                updateUIState();
                showNotification('Answer –ø—Ä–∏–Ω—è—Ç! –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'success');
            } catch (error) {
                console.error('Error confirming answer:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        function setupPeerConnectionListeners() {
            state.peerConnection.onicecandidate = (event) => {
                if (event.candidate === null) {
                    console.log('ICE gathering complete');
                }
            };
            
            state.peerConnection.oniceconnectionstatechange = () => {
                console.log('ICE connection state:', state.peerConnection.iceConnectionState);
                
                if (state.peerConnection.iceConnectionState === 'connected' ||
                    state.peerConnection.iceConnectionState === 'completed') {
                    updateConnectionStatus('connected');
                } else if (state.peerConnection.iceConnectionState === 'disconnected' ||
                           state.peerConnection.iceConnectionState === 'failed' ||
                           state.peerConnection.iceConnectionState === 'closed') {
                    updateConnectionStatus('disconnected');
                    showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'error');
                }
            };
            
            state.peerConnection.onicegatheringstatechange = () => {
                console.log('ICE gathering state:', state.peerConnection.iceGatheringState);
            };
        }
        
        function setupDataChannelListeners(channel) {
            channel.onopen = () => {
                console.log('Data channel opened');
                updateConnectionStatus('connected');
                showChatArea();
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ú–æ–∂–µ—Ç–µ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.', 'success');
            };
            
            channel.onclose = () => {
                console.log('Data channel closed');
                updateConnectionStatus('disconnected');
            };
            
            channel.onerror = (error) => {
                console.error('Data channel error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∫–∞–Ω–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
            };
            
            channel.onmessage = (event) => {
                receiveMessage(event.data);
            };
        }
        
        function waitForICEGathering() {
            return new Promise((resolve) => {
                if (state.peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    const checkState = () => {
                        if (state.peerConnection.iceGatheringState === 'complete') {
                            state.peerConnection.removeEventListener('icegatheringstatechange', checkState);
                            resolve();
                        }
                    };
                    state.peerConnection.addEventListener('icegatheringstatechange', checkState);
                }
            });
        }
        
        // Messaging Functions
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) return;
            
            if (!state.dataChannel || state.dataChannel.readyState !== 'open') {
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'error');
                return;
            }
            
            try {
                const message = {
                    text: text,
                    timestamp: Date.now()
                };
                
                state.dataChannel.send(JSON.stringify(message));
                displayMessage(message, true);
                elements.messageInput.value = '';
                elements.messageInput.focus();
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            }
        }
        
        function receiveMessage(data) {
            try {
                const message = JSON.parse(data);
                displayMessage(message, false);
            } catch (error) {
                console.error('Error receiving message:', error);
            }
        }
        
        function displayMessage(message, isOwn) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOwn ? 'own' : 'partner'}`;
            
            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            contentEl.textContent = message.text;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = formatTime(message.timestamp);
            
            messageEl.appendChild(contentEl);
            messageEl.appendChild(timeEl);
            
            elements.messages.appendChild(messageEl);
            scrollToBottom();
            
            state.messages.push({ ...message, isOwn });
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function scrollToBottom() {
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }
        
        function clearChat() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π?')) {
                elements.messages.innerHTML = '';
                state.messages = [];
                showNotification('–ß–∞—Ç –æ—á–∏—â–µ–Ω', 'success');
            }
        }
        
        // Connection Management
        function disconnect() {
            if (confirm('–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ?')) {
                logState('Before disconnect');
                
                if (state.dataChannel) {
                    state.dataChannel.close();
                    state.dataChannel = null;
                }
                
                if (state.peerConnection) {
                    state.peerConnection.close();
                    state.peerConnection = null;
                }
                
                // Reset state flags
                resetConnectionState();
                
                // Reset UI
                elements.setupPanel.classList.remove('hidden');
                elements.chatArea.classList.remove('active');
                elements.messages.innerHTML = '';
                state.messages = [];
                
                // Reset form fields
                elements.offerTextarea.value = '';
                elements.answerInput.value = '';
                elements.offerInput.value = '';
                elements.answerTextarea.value = '';
                elements.offerGroup.style.display = 'none';
                elements.answerGroup.style.display = 'none';
                elements.generatedAnswerGroup.style.display = 'none';
                
                state.role = null;
                state.localSDP = null;
                state.remoteSDP = null;
                
                updateConnectionStatus('disconnected');
                showNotification('–û—Ç–∫–ª—é—á–µ–Ω–æ. –ì–æ—Ç–æ–≤–æ –∫ –Ω–æ–≤–æ–º—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é.', 'success');
                
                console.log('Connection reset complete');
            }
        }
        
        function showChatArea() {
            elements.setupPanel.classList.add('hidden');
            elements.chatArea.classList.add('active');
            elements.messageInput.focus();
        }
        
        function updateConnectionStatus(status) {
            state.connectionState = status;
            const dot = elements.statusDot;
            const text = elements.statusText;
            
            dot.className = 'status-dot';
            
            // Get detailed state info
            const pc = state.peerConnection;
            const signalingState = pc ? pc.signalingState : 'unknown';
            const connectionState = pc ? pc.connectionState : 'unknown';
            const iceState = pc ? pc.iceConnectionState : 'unknown';
            
            let statusText = '';
            
            switch (status) {
                case 'disconnected':
                    statusText = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'gathering':
                    dot.classList.add('connecting');
                    statusText = '–°–±–æ—Ä ICE...';
                    break;
                case 'connecting':
                    dot.classList.add('connecting');
                    statusText = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    break;
                case 'connected':
                    dot.classList.add('connected');
                    statusText = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'error':
                    statusText = '–û—à–∏–±–∫–∞';
                    break;
            }
            
            // Add detailed state info for debugging
            if (pc) {
                statusText += ` (Signal: ${signalingState})`;
            }
            
            text.textContent = statusText;
            
            // Update UI state
            updateUIState();
        }
        
        // Update UI button states based on connection state
        function updateUIState() {
            const pc = state.peerConnection;
            const signalingState = pc ? pc.signalingState : 'unknown';
            
            // For Initiator mode
            if (elements.createOfferBtn) {
                elements.createOfferBtn.disabled = 
                    (pc && signalingState !== 'stable') || state.offerCreated;
            }
            
            if (elements.confirmAnswerBtn) {
                elements.confirmAnswerBtn.disabled = 
                    (!pc || signalingState !== 'have-local-offer') || state.remoteDescriptionSet;
            }
            
            // For Receiver mode
            if (elements.confirmOfferBtn) {
                elements.confirmOfferBtn.disabled = 
                    (pc && signalingState !== 'stable') || state.remoteDescriptionSet;
            }
        }
        
        // QR Code Functions
        function showQRCode(text) {
            if (!text) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è QR-–∫–æ–¥–∞', 'error');
                return;
            }
            
            // Clear previous QR code
            elements.qrcodeContainer.innerHTML = '';
            
            // Generate new QR code
            new QRCode(elements.qrcodeContainer, {
                text: text,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            elements.qrModal.classList.add('active');
        }
        
        function closeQRModal() {
            elements.qrModal.classList.remove('active');
            elements.qrcodeContainer.innerHTML = '';
        }
        
        async function startQRScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                state.scannerStream = stream;
                elements.scannerVideo.srcObject = stream;
                elements.scannerModal.classList.add('active');
                
                // Start scanning
                scanQRCode();
            } catch (error) {
                console.error('Camera access error:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message, 'error');
            }
        }
        
        function scanQRCode() {
            const video = elements.scannerVideo;
            const canvas = elements.scannerCanvas;
            const ctx = canvas.getContext('2d');
            
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        elements.offerInput.value = code.data;
                        stopQRScanner();
                        showNotification('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!', 'success');
                        return;
                    }
                }
                
                state.scannerAnimationId = requestAnimationFrame(tick);
            }
            
            tick();
        }
        
        function stopQRScanner() {
            if (state.scannerStream) {
                state.scannerStream.getTracks().forEach(track => track.stop());
                state.scannerStream = null;
            }
            
            if (state.scannerAnimationId) {
                cancelAnimationFrame(state.scannerAnimationId);
                state.scannerAnimationId = null;
            }
            
            elements.scannerVideo.srcObject = null;
            elements.scannerModal.classList.remove('active');
        }
        
        // Utility Functions
        async function copyToClipboard(text, successMessage = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!') {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                showNotification(successMessage, 'success');
            } catch (error) {
                console.error('Copy error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>