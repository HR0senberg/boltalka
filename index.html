<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>P2P Chat - Decentralized Messaging</title>
    
    <!-- External Libraries -->
    <script type="text/javascript" src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=pKhmGTEnlKp7kLmy50ekEuNYH0pzdOhn4rlQRIsEReTrCwJGYAD8mFMHHcmneebPIej8qsjO2sC3ephhYwwBslYAube7BfQ3pUdWf3DryjE6NZJJ-1ZTyBXeoBHcUkjQ-xN6O-wsvMC76H6xOJZ40ckNeUwofg7WlFP5-4_O4wylTDT6aCG187jnWkxgQkuQakHmVcmeRP1WKXswjocPjXwik-LOmAcu_delBw99wPa9Y6RXaDynH84TzliMCymU_VnGbeFXFR278l2w0OrORRQD4Q_X73M3HN3dnkwsXTWGFjV2kricguwElcqomFMJ4bqu38MT9rf0JqOTScOrkKFSI_zBUicqHKMWYHGuI4TLxmyWaIH_mJjUafV6ikfk_YvZ5HzcEbpYMGu1kUxC6X9Ebb66aC7-kDZpdZY2Rlgmj-rSHWZgKd-H6rlwFHuBcxsq4rOnrUuc5-fGjrBi7NiAl1G3EhtInzchxzFKs6GD0g3Q_4kkbyyaJl7AoWjlsI7trE3YXtiQOpiBL0fWY46yktkHiuaWPJmUURkwtskx-fZAsQ-wj-y5fnHNfINfgRsiPD7-LV1QOWZS_0Yov1buaIPMnbhotPn2CoTJL_roKqQHF0jGK8Elk-pna3ws5qeM9Z15x9-isc8N6ao60sPvwUeu5U6O3E7hvnRWBjKA5hnAULSRdjvc8iawECwoN9_aUoD5IjZ6Nt9Nbr2pGz9TxDxpf16pG6_neo6Sgp4x0KMOffsCD5CAjGdWxrsyuJe3tii79YRaIzI4pOQDRrSdnurM06-FQFOK2aKXE007c8R8cSexcxYrshk7d0tCpD8iL1euAuD1OFsCTuss5vW5yzjafKMgCLjjAaRNpequZ-pC8tzwhuh9-AVz5j138jjhWmUAI---i40RMJaXIRCbxUf0wiiAKdZrak91NGUwmKv_i_BBNyG9IpmO9poXWqtAW7F9tG_aiwYbTHCL0ifs2fcWIbw7QsdF0mFOygq2_9w9R0LKrrAZhnu5B7vD8E9ursiXMhQki9m7DHTK-rkfFULpkWbxkuOjPw2LnVj68nI_QV1HZNch-slYliYZ2IKvLvkQDlPjRJpI_jZ_imfouU8uGCfR2pxa1ODse9TrJoEh_5i4BL9Aj2HRBfuQZxchLxNLbVbPLuDyBxxTTdi49sdMHG5CIl8dlOnwcunqjzz2dVKxxWgxuHeWfr4I3nV5K4E4Hw-4iA4V82VNrs6Vx5yAl874rPuvulHERMKKsHRdWZo5HOHDF2txNSzdQ64n7FG3Y5R3MuEHG_UAh1kYPkoj78skmNS38gsSfOXmk-NpK3wEk2pH9WALdRzn6eBe0I8NLMxi0ANkWlTuctUFYAxr49zOZmdZ_lrQTj7L-2EW0oDDVf1MJwKpnoWiDeyRrf7vHREbEvyG62nILzsnE6Qj58el4xte7Xb7-49X_w1Nd_E8HDzMfM0eoMUfXpqsUbUDXmj5n-DdSNBe6tExe1mo5Zv-O1NdETmq2vo5mmNIrb3VXJowh2rsDSoQeW3EpcXe9L5xHasfHGKEHWw__-1wJynrePrCYOcvKGyHn5D0Nz1F89tScPEYVR5QR5UIt3k5fihmanasf9sdYwuulM3-s1YWAWI_PJ8rJIapy018zGUPE72xgiBbyyHq2jST_vM6dED6BS7KBMl8Y18K-wuwIR_EWRpv012eiWldAgJJs6pNc1O1eJUjII6TxtmStoR9IPEU6oIAewPNbas94BZsYvdkZXC_fW21R0QFV-4eN_IJqpEIEtbY02dqlkqYE0bWNY6D5WjDSNWdApnjFoH_tFvKntgg1Nxom1ZocahiBCXuTATGcVDDeOFcWEh-_frprJGDO5U9FeVpCn6y3HZ1wf1eAUA2eB9TSIfETY1Ko6TNPs8AIb1xHaKHUrSWJld71uA2o5E6BfeQcrhWo5Sq4Z4_pq5Ij_5MBBFdeo9kOeWJZ_-LOKlcukfe6epZAl0jVTDNCgC361ni_14-dTxAd0qjsyp8_Kp-AGs2Eo8gtTgH0kb7NK84uODmAfEDxhB8Fwhby44YkYerlOVoxSOitjjLMh2x0lMdKW7eI-NE3ilXNw-Pv-SGPZZm44hxqAA9e7OOVdiJzLgSC0w3DoAjRtfKAq9zMOiEm0Hu6r76DtyCMFBFkDQX8XLFLc0_2jh_8aR8m7Y1l5gzcxIzObj9vmgQoNnimEuDqG4RmleRw8HEowzdqLgWKEQDM7oMcSTaBCwusYjJQSRLqg" charset="UTF-8"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    
    <style>
        /* Design System Variables */
        :root {
            --color-background: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #333333;
            --color-text-secondary: #666666;
            --color-primary: #2196F3;
            --color-primary-hover: #1976D2;
            --color-own-message: #E3F2FD;
            --color-partner-message: #EEEEEE;
            --color-status-disconnected: #f44336;
            --color-status-connecting: #FFC107;
            --color-status-connected: #4CAF50;
            --color-border: #dddddd;
            --color-shadow: rgba(0, 0, 0, 0.1);
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.5rem;
        }
        
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-background);
            padding: 10px;
        }
        
        /* Layout */
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 8px var(--color-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px);
        }
        
        /* Header */
        .header {
            background: var(--color-primary);
            color: white;
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-status-disconnected);
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: var(--color-status-connected);
        }
        
        .status-dot.connecting {
            background: var(--color-status-connecting);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Setup Panel */
        .setup-panel {
            padding: var(--space-lg);
            overflow-y: auto;
        }
        
        .setup-panel.hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--color-border);
        }
        
        .tab {
            padding: var(--space-md);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--color-text-secondary);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-height: 44px;
        }
        
        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-lg);
        }
        
        label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 500;
            font-size: var(--font-size-sm);
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-family: monospace;
            resize: vertical;
            background: var(--color-background);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        textarea[readonly] {
            background: #fafafa;
            cursor: default;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--color-primary-hover);
        }
        
        .btn-secondary {
            background: var(--color-border);
            color: var(--color-text);
        }
        
        .btn-secondary:hover {
            background: #cccccc;
        }
        
        .btn-danger {
            background: var(--color-status-disconnected);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        
        .btn-full {
            width: 100%;
        }
        
        /* Chat Area */
        .chat-area {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .chat-area.active {
            display: flex;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.own {
            align-self: flex-end;
            align-items: flex-end;
        }
        
        .message.partner {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        .message-content {
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            word-wrap: break-word;
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        
        .message.own .message-content {
            background: var(--color-own-message);
            color: var(--color-text);
            border-bottom-right-radius: var(--radius-sm);
        }
        
        .message.partner .message-content {
            background: var(--color-partner-message);
            color: var(--color-text);
            border-bottom-left-radius: var(--radius-sm);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-top: var(--space-xs);
        }
        
        /* Input Area */
        .input-area {
            padding: var(--space-md);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
            flex-shrink: 0;
        }
        
        .input-group {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: inherit;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        /* Footer */
        .footer {
            padding: var(--space-md);
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
            flex-shrink: 0;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--color-surface);
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            text-align: center;
        }
        
        .modal-close {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: var(--color-border);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: #cccccc;
        }
        
        #qrcode {
            margin: var(--space-lg) auto;
            display: inline-block;
        }
        
        /* QR Scanner */
        #scanner-video {
            max-width: 100%;
            border-radius: var(--radius-md);
            margin: var(--space-md) 0;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--color-surface);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px var(--color-shadow);
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification.success {
            border-left: 4px solid var(--color-status-connected);
        }
        
        .notification.error {
            border-left: 4px solid var(--color-status-disconnected);
        }
        
        /* Responsive Design */
        @media (min-width: 600px) {
            body {
                font-size: 15px;
                padding: 20px;
            }
            
            .container {
                height: calc(100vh - 40px);
            }
            
            textarea {
                min-height: 150px;
            }
        }
        
        @media (min-width: 1024px) {
            body {
                font-size: 16px;
                padding: 30px;
            }
            
            .container {
                max-width: 1200px;
                height: calc(100vh - 60px);
            }
            
            .message {
                max-width: 60%;
            }
            
            .modal-content {
                max-width: 600px;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-sm {
            margin-bottom: var(--space-sm);
        }
        
        .mb-md {
            margin-bottom: var(--space-md);
        }
        
        .mb-lg {
            margin-bottom: var(--space-lg);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>P2P Chat</h1>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Setup Panel -->
            <div class="setup-panel" id="setupPanel">
                <div class="tabs">
                    <button class="tab active" data-tab="create">–°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                    <button class="tab" data-tab="join">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                </div>
                
                <!-- Create Connection Tab -->
                <div class="tab-content active" id="createTab">
                    <div class="form-group">
                        <button class="btn btn-primary btn-full" id="createOfferBtn">
                            üîó –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                        </button>
                    </div>
                    
                    <div class="form-group" id="offerGroup" style="display: none;">
                        <label>SDP Offer (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é):</label>
                        <textarea id="offerTextarea" readonly placeholder="SDP offer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="copyOfferBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-secondary" id="showOfferQRBtn">üì± –ü–æ–∫–∞–∑–∞—Ç—å QR</button>
                        </div>
                    </div>
                    
                    <div class="form-group" id="answerGroup" style="display: none;">
                        <label>–í–≤–µ–¥–∏—Ç–µ SDP Answer:</label>
                        <textarea id="answerInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ SDP answer –æ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è..."></textarea>
                        <button class="btn btn-primary btn-full" id="confirmAnswerBtn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </div>
                </div>
                
                <!-- Join Connection Tab -->
                <div class="tab-content" id="joinTab">
                    <div class="form-group">
                        <label>–í–≤–µ–¥–∏—Ç–µ SDP Offer –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞:</label>
                        <textarea id="offerInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ SDP offer –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR-—Å–∫–∞–Ω–µ—Ä..."></textarea>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="scanOfferQRBtn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
                            <button class="btn btn-primary" id="confirmOfferBtn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="form-group" id="generatedAnswerGroup" style="display: none;">
                        <label>SDP Answer (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É):</label>
                        <textarea id="answerTextarea" readonly placeholder="SDP answer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="copyAnswerBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-secondary" id="showAnswerQRBtn">üì± –ü–æ–∫–∞–∑–∞—Ç—å QR</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="messages" id="messages"></div>
                
                <div class="input-area">
                    <div class="input-group">
                        <input type="text" class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                        <button class="btn btn-primary" id="sendBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="clearChatBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                        <button class="btn btn-danger" id="disconnectBtn">üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            üîí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤, –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é P2P
        </div>
    </div>
    
    <!-- QR Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <button class="modal-close" id="closeQRModal">√ó</button>
            <h2 class="mb-md">QR –ö–æ–¥</h2>
            <div id="qrcode"></div>
            <p class="text-center" style="margin-top: var(--space-md); color: var(--color-text-secondary);">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>
        </div>
    </div>
    
    <!-- Scanner Modal -->
    <div class="modal" id="scannerModal">
        <div class="modal-content">
            <button class="modal-close" id="closeScannerModal">√ó</button>
            <h2 class="mb-md">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</h2>
            <video id="scanner-video" autoplay playsinline></video>
            <canvas id="scanner-canvas" style="display: none;"></canvas>
            <p class="text-center" style="color: var(--color-text-secondary);">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</p>
        </div>
    </div>
    
    <script>
        // Application State
        const state = {
            role: null, // 'initiator' or 'receiver'
            connectionState: 'disconnected',
            peerConnection: null,
            dataChannel: null,
            localSDP: null,
            remoteSDP: null,
            messages: [],
            scannerStream: null,
            scannerAnimationId: null
        };
        
        // DOM Elements
        const elements = {
            // Status
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            
            // Panels
            setupPanel: document.getElementById('setupPanel'),
            chatArea: document.getElementById('chatArea'),
            
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            createTab: document.getElementById('createTab'),
            joinTab: document.getElementById('joinTab'),
            
            // Create Connection
            createOfferBtn: document.getElementById('createOfferBtn'),
            offerGroup: document.getElementById('offerGroup'),
            offerTextarea: document.getElementById('offerTextarea'),
            copyOfferBtn: document.getElementById('copyOfferBtn'),
            showOfferQRBtn: document.getElementById('showOfferQRBtn'),
            answerGroup: document.getElementById('answerGroup'),
            answerInput: document.getElementById('answerInput'),
            confirmAnswerBtn: document.getElementById('confirmAnswerBtn'),
            
            // Join Connection
            offerInput: document.getElementById('offerInput'),
            scanOfferQRBtn: document.getElementById('scanOfferQRBtn'),
            confirmOfferBtn: document.getElementById('confirmOfferBtn'),
            generatedAnswerGroup: document.getElementById('generatedAnswerGroup'),
            answerTextarea: document.getElementById('answerTextarea'),
            copyAnswerBtn: document.getElementById('copyAnswerBtn'),
            showAnswerQRBtn: document.getElementById('showAnswerQRBtn'),
            
            // Chat
            messages: document.getElementById('messages'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            
            // Modals
            qrModal: document.getElementById('qrModal'),
            closeQRModal: document.getElementById('closeQRModal'),
            qrcodeContainer: document.getElementById('qrcode'),
            scannerModal: document.getElementById('scannerModal'),
            closeScannerModal: document.getElementById('closeScannerModal'),
            scannerVideo: document.getElementById('scanner-video'),
            scannerCanvas: document.getElementById('scanner-canvas')
        };
        
        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        
        // Initialize Application
        function init() {
            setupEventListeners();
            updateConnectionStatus('disconnected');
        }
        
        // Setup Event Listeners
        function setupEventListeners() {
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Create connection
            elements.createOfferBtn.addEventListener('click', createOffer);
            elements.copyOfferBtn.addEventListener('click', () => copyToClipboard(elements.offerTextarea.value, 'Offer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
            elements.showOfferQRBtn.addEventListener('click', () => showQRCode(elements.offerTextarea.value));
            elements.confirmAnswerBtn.addEventListener('click', confirmAnswer);
            
            // Join connection
            elements.scanOfferQRBtn.addEventListener('click', startQRScanner);
            elements.confirmOfferBtn.addEventListener('click', confirmOffer);
            elements.copyAnswerBtn.addEventListener('click', () => copyToClipboard(elements.answerTextarea.value, 'Answer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
            elements.showAnswerQRBtn.addEventListener('click', () => showQRCode(elements.answerTextarea.value));
            
            // Chat
            elements.sendBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            elements.clearChatBtn.addEventListener('click', clearChat);
            elements.disconnectBtn.addEventListener('click', disconnect);
            
            // Modals
            elements.closeQRModal.addEventListener('click', closeQRModal);
            elements.closeScannerModal.addEventListener('click', stopQRScanner);
            elements.qrModal.addEventListener('click', (e) => {
                if (e.target === elements.qrModal) closeQRModal();
            });
            elements.scannerModal.addEventListener('click', (e) => {
                if (e.target === elements.scannerModal) stopQRScanner();
            });
        }
        
        // Tab Switching
        function switchTab(tabName) {
            elements.tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            if (tabName === 'create') {
                elements.createTab.classList.add('active');
                elements.joinTab.classList.remove('active');
            } else {
                elements.createTab.classList.remove('active');
                elements.joinTab.classList.add('active');
            }
        }
        
        // WebRTC Functions
        async function createOffer() {
            try {
                state.role = 'initiator';
                updateConnectionStatus('gathering');
                
                // Create peer connection
                state.peerConnection = new RTCPeerConnection(rtcConfig);
                setupPeerConnectionListeners();
                
                // Create data channel
                state.dataChannel = state.peerConnection.createDataChannel('chat');
                setupDataChannelListeners(state.dataChannel);
                
                // Create offer
                const offer = await state.peerConnection.createOffer();
                await state.peerConnection.setLocalDescription(offer);
                
                // Wait for ICE gathering to complete
                await waitForICEGathering();
                
                // Display offer
                state.localSDP = state.peerConnection.localDescription.sdp;
                elements.offerTextarea.value = JSON.stringify(state.peerConnection.localDescription);
                elements.offerGroup.style.display = 'block';
                elements.answerGroup.style.display = 'block';
                
                showNotification('Offer —Å–æ–∑–¥–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é.', 'success');
            } catch (error) {
                console.error('Error creating offer:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        async function confirmOffer() {
            try {
                const offerText = elements.offerInput.value.trim();
                if (!offerText) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ SDP offer', 'error');
                    return;
                }
                
                state.role = 'receiver';
                updateConnectionStatus('gathering');
                
                // Parse offer
                const offer = JSON.parse(offerText);
                
                // Create peer connection
                state.peerConnection = new RTCPeerConnection(rtcConfig);
                setupPeerConnectionListeners();
                
                // Setup data channel listener
                state.peerConnection.ondatachannel = (event) => {
                    state.dataChannel = event.channel;
                    setupDataChannelListeners(state.dataChannel);
                };
                
                // Set remote description
                await state.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // Create answer
                const answer = await state.peerConnection.createAnswer();
                await state.peerConnection.setLocalDescription(answer);
                
                // Wait for ICE gathering to complete
                await waitForICEGathering();
                
                // Display answer
                state.localSDP = state.peerConnection.localDescription.sdp;
                elements.answerTextarea.value = JSON.stringify(state.peerConnection.localDescription);
                elements.generatedAnswerGroup.style.display = 'block';
                
                showNotification('Answer —Å–æ–∑–¥–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É.', 'success');
            } catch (error) {
                console.error('Error confirming offer:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        async function confirmAnswer() {
            try {
                const answerText = elements.answerInput.value.trim();
                if (!answerText) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ SDP answer', 'error');
                    return;
                }
                
                updateConnectionStatus('connecting');
                
                // Parse answer
                const answer = JSON.parse(answerText);
                
                // Set remote description
                await state.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                
                showNotification('Answer –ø—Ä–∏–Ω—è—Ç! –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'success');
            } catch (error) {
                console.error('Error confirming answer:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                updateConnectionStatus('error');
            }
        }
        
        function setupPeerConnectionListeners() {
            state.peerConnection.onicecandidate = (event) => {
                if (event.candidate === null) {
                    console.log('ICE gathering complete');
                }
            };
            
            state.peerConnection.oniceconnectionstatechange = () => {
                console.log('ICE connection state:', state.peerConnection.iceConnectionState);
                
                if (state.peerConnection.iceConnectionState === 'connected' ||
                    state.peerConnection.iceConnectionState === 'completed') {
                    updateConnectionStatus('connected');
                } else if (state.peerConnection.iceConnectionState === 'disconnected' ||
                           state.peerConnection.iceConnectionState === 'failed' ||
                           state.peerConnection.iceConnectionState === 'closed') {
                    updateConnectionStatus('disconnected');
                    showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'error');
                }
            };
            
            state.peerConnection.onicegatheringstatechange = () => {
                console.log('ICE gathering state:', state.peerConnection.iceGatheringState);
            };
        }
        
        function setupDataChannelListeners(channel) {
            channel.onopen = () => {
                console.log('Data channel opened');
                updateConnectionStatus('connected');
                showChatArea();
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ú–æ–∂–µ—Ç–µ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.', 'success');
            };
            
            channel.onclose = () => {
                console.log('Data channel closed');
                updateConnectionStatus('disconnected');
            };
            
            channel.onerror = (error) => {
                console.error('Data channel error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∫–∞–Ω–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
            };
            
            channel.onmessage = (event) => {
                receiveMessage(event.data);
            };
        }
        
        function waitForICEGathering() {
            return new Promise((resolve) => {
                if (state.peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    const checkState = () => {
                        if (state.peerConnection.iceGatheringState === 'complete') {
                            state.peerConnection.removeEventListener('icegatheringstatechange', checkState);
                            resolve();
                        }
                    };
                    state.peerConnection.addEventListener('icegatheringstatechange', checkState);
                }
            });
        }
        
        // Messaging Functions
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) return;
            
            if (!state.dataChannel || state.dataChannel.readyState !== 'open') {
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'error');
                return;
            }
            
            try {
                const message = {
                    text: text,
                    timestamp: Date.now()
                };
                
                state.dataChannel.send(JSON.stringify(message));
                displayMessage(message, true);
                elements.messageInput.value = '';
                elements.messageInput.focus();
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            }
        }
        
        function receiveMessage(data) {
            try {
                const message = JSON.parse(data);
                displayMessage(message, false);
            } catch (error) {
                console.error('Error receiving message:', error);
            }
        }
        
        function displayMessage(message, isOwn) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOwn ? 'own' : 'partner'}`;
            
            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            contentEl.textContent = message.text;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = formatTime(message.timestamp);
            
            messageEl.appendChild(contentEl);
            messageEl.appendChild(timeEl);
            
            elements.messages.appendChild(messageEl);
            scrollToBottom();
            
            state.messages.push({ ...message, isOwn });
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function scrollToBottom() {
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }
        
        function clearChat() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π?')) {
                elements.messages.innerHTML = '';
                state.messages = [];
                showNotification('–ß–∞—Ç –æ—á–∏—â–µ–Ω', 'success');
            }
        }
        
        // Connection Management
        function disconnect() {
            if (confirm('–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ?')) {
                if (state.dataChannel) {
                    state.dataChannel.close();
                    state.dataChannel = null;
                }
                
                if (state.peerConnection) {
                    state.peerConnection.close();
                    state.peerConnection = null;
                }
                
                // Reset UI
                elements.setupPanel.classList.remove('hidden');
                elements.chatArea.classList.remove('active');
                elements.messages.innerHTML = '';
                state.messages = [];
                
                // Reset form fields
                elements.offerTextarea.value = '';
                elements.answerInput.value = '';
                elements.offerInput.value = '';
                elements.answerTextarea.value = '';
                elements.offerGroup.style.display = 'none';
                elements.answerGroup.style.display = 'none';
                elements.generatedAnswerGroup.style.display = 'none';
                
                state.role = null;
                state.localSDP = null;
                state.remoteSDP = null;
                
                updateConnectionStatus('disconnected');
                showNotification('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'success');
            }
        }
        
        function showChatArea() {
            elements.setupPanel.classList.add('hidden');
            elements.chatArea.classList.add('active');
            elements.messageInput.focus();
        }
        
        function updateConnectionStatus(status) {
            state.connectionState = status;
            const dot = elements.statusDot;
            const text = elements.statusText;
            
            dot.className = 'status-dot';
            
            switch (status) {
                case 'disconnected':
                    text.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'gathering':
                    dot.classList.add('connecting');
                    text.textContent = '–°–±–æ—Ä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...';
                    break;
                case 'connecting':
                    dot.classList.add('connecting');
                    text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    break;
                case 'connected':
                    dot.classList.add('connected');
                    text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'error':
                    text.textContent = '–û—à–∏–±–∫–∞';
                    break;
            }
        }
        
        // QR Code Functions
        function showQRCode(text) {
            if (!text) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è QR-–∫–æ–¥–∞', 'error');
                return;
            }
            
            // Clear previous QR code
            elements.qrcodeContainer.innerHTML = '';
            
            // Generate new QR code
            new QRCode(elements.qrcodeContainer, {
                text: text,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            elements.qrModal.classList.add('active');
        }
        
        function closeQRModal() {
            elements.qrModal.classList.remove('active');
            elements.qrcodeContainer.innerHTML = '';
        }
        
        async function startQRScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                state.scannerStream = stream;
                elements.scannerVideo.srcObject = stream;
                elements.scannerModal.classList.add('active');
                
                // Start scanning
                scanQRCode();
            } catch (error) {
                console.error('Camera access error:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message, 'error');
            }
        }
        
        function scanQRCode() {
            const video = elements.scannerVideo;
            const canvas = elements.scannerCanvas;
            const ctx = canvas.getContext('2d');
            
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        elements.offerInput.value = code.data;
                        stopQRScanner();
                        showNotification('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!', 'success');
                        return;
                    }
                }
                
                state.scannerAnimationId = requestAnimationFrame(tick);
            }
            
            tick();
        }
        
        function stopQRScanner() {
            if (state.scannerStream) {
                state.scannerStream.getTracks().forEach(track => track.stop());
                state.scannerStream = null;
            }
            
            if (state.scannerAnimationId) {
                cancelAnimationFrame(state.scannerAnimationId);
                state.scannerAnimationId = null;
            }
            
            elements.scannerVideo.srcObject = null;
            elements.scannerModal.classList.remove('active');
        }
        
        // Utility Functions
        async function copyToClipboard(text, successMessage = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!') {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                showNotification(successMessage, 'success');
            } catch (error) {
                console.error('Copy error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>